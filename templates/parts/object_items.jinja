{% from "parts/create_forms.jinja" import post_form, page_form, book_form, shelf_form %}
{% macro item_info(node) %}
    <div class="object-info">
        <div class="evaluation">
            <div>fav:{{ node.good }}</div>
            <div>bad:{{ node.bad }}</div>
        </div>
        <div class="created">
            <div>{{ node.created_name }}</div>
            <div>{{ node.f_created_at }}</div>
        </div>
    </div>
{% endmacro %}
{% macro post_item(node) %}
    <div class="post item">
        <div class="post-content">{{ node.content }}</div>
        {{ item_info(node) }}
    </div>
{% endmacro %}
{% macro page_item(node) %}
    <div class="page item">
        <div class="page-parson">
            <div class="page-content">{{ node.content }}</div>
            {{ item_info(node) }}
        </div>
        <div class="page-children">
            {% for child in node.children %}{{ post_item(child) }}{% endfor %}
            <div class="flex-space"></div>
            {{ post_form("post_to_page",parent_id=node.id) }}
        </div>
    </div>
{% endmacro %}
{% macro book_cover(node) %}
    <div class="page-item book-cover">
        <div class="book-content">{{ node.content }}</div>
        {{ item_info(node) }}
    </div>
{% endmacro %}
{% macro book_page(page_node) %}
    <div class="page-item book-page">{{ page_item(page_node) }}</div>
{% endmacro %}
{% macro book_back(node) %}
    <div class="page-item book-back">{{ page_form("page_to_book") }}</div>
{% endmacro %}
{% macro book_pager(current_page, total_pages) %}
    <div class="book-pager">
        {% set last = total_pages - 1 %}
        {# --- 先頭 --- #}
        <button name="page"
                value="0"
                class="pager-item {% if current_page == 0 %}active{% endif %}">0</button>
        {# --- 前側の省略 --- #}
        {% if current_page >= 3 %}<span class="pager-sep">-</span>{% endif %}
        {# --- current 前 --- #}
        {% if current_page - 1 > 0 %}
            <button name="page" value="{{ current_page - 1 }}" class="pager-item">{{ current_page - 1 }}</button>
        {% endif %}
        {# --- current --- #}
        {% if current_page != 0 and current_page != last %}
            <button name="page" value="{{ current_page }}" class="pager-item active">{{ current_page }}</button>
        {% endif %}
        {# --- current 後 --- #}
        {% if current_page + 1 < last %}
            <button name="page" value="{{ current_page + 1 }}" class="pager-item">{{ current_page + 1 }}</button>
        {% endif %}
        {# --- 後側の省略 --- #}
        {% if current_page <= last - 3 %}<span class="pager-sep">-</span>{% endif %}
        {# --- 最後 --- #}
        {% if last != 0 %}
            <button name="page"
                    value="{{ last }}"
                    class="pager-item {% if current_page == last %}active{% endif %}">{{ last }}</button>
        {% endif %}
    </div>
{% endmacro %}
{% macro book_item(node,pops) %}
    {% set current_page = pops.current_page | default(0) | int %}
    {% set child_count = node.children | length %}
    {% set total_pages = child_count + 2 %} {# 表紙 + 子 + 背表紙 #}
    <div class="book item">
        {# 表示ページ #}
        {% if current_page == 0 %}
            {{ book_cover(node) }}
        {% elif 1 <= current_page <= child_count %}
            {{ book_page(node.children[current_page - 1]) }}
        {% elif current_page == child_count + 1 %}
            {{ book_back(node) }}
        {% else %}
            {# 保険：範囲外は表紙 #}
            {{ book_cover(node) }}
        {% endif %}
        {# pagerは常に最下部 #}
        {{ book_pager(current_page, total_pages) }}
    </div>
{% endmacro %}
